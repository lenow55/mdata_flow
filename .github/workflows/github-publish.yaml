name: Publish Poetry Package

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-and-publish:
    name: Build and Publish Package
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Configure Poetry for GitHub Packages
        run: |
          poetry config repositories.github "https://maven.pkg.github.com/${{ github.repository }}"
          poetry config http-basic.github "${{ secrets.GITHUB_ACTOR }}" "${{ secrets.GITHUB_TOKEN }}"

      - name: Install Dependencies
        run: poetry install

      - name: Build Package
        run: poetry build

      - name: Get Version from Tag
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          if [[ "$VERSION" == *-rc* ]]; then
            echo "PRERELEASE=true" >> $GITHUB_ENV
          else
            echo "PRERELEASE=false" >> $GITHUB_ENV
          fi

      - name: Publish to GitHub Packages
        if: env.PRERELEASE == 'false'
        run: poetry publish -r github

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref }}
          name: Release ${{ env.VERSION }}
          body: "Automatically generated release for version ${{ env.VERSION }}."
          draft: false
          prerelease: ${{ env.PRERELEASE }}
          files: dist/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
